
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krithy Books | new Releases</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

  <!--  -->
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/prductlist.css">
    <link rel="icon" href="/img/logo/title_logo.svg" type="image/svg" >


</head>
<body>
    

    <style>
        .bg-D9D9D9{
            background-color: #D9D9D9;
        }
 
            .scaled{
                max-width: 100px;
            }
            .scaled-main{
                max-width: 16rem;
                max-height: 22rem;
            }
            .selected {
                color: yellow;
                
            }

    </style>
    
    <nav class="navbar navbar-expand-lg d-flex shadow">
        <div class="container-fluid">
            <!-- Logo -->
            <a class="navbar-brand logohome mx-auto" href="/">
                <span class="k">K</span>rithy
            </a>
    
            <!-- Navbar Toggler -->
            <button class="navbar-toggler shadow" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
    
            <!-- Navbar Collapse -->
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <div class="container d-flex justify-content-center">
    
                    <!-- Search Bar -->
                    <!-- <form action="/search" class=" d-flex justify-content-end" method="get" id="searchForm">
                        <input class="form-control me-2" type="text" placeholder="Search" aria-label="Search">
                        <button class="btn btn-outline-primary" type="submit">Search</button>
                    </form> -->
                    <form action="/search" class="container d-flex justify-content-end" method="get" id="searchForm" onsubmit="return search();">
                        <div class="input-group flex-nowrap my-2 " style="width: 250px">
                            <input type="text" class="form-control" placeholder="Search" id="searchInput" name="searchInput" />
                            <button type="submit" class="btn btn-primary" style="height: fit-content;">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>
                </div>
                <ul class="navbar-nav ms-auto hamurgerToggle">
                                             <!-- logout button -->
                <% if (session) { %>
                <li class="nav-item">
                    <div class="logout">
                    <button id="logoutButton" class="btn bgtheme border rounded-2 hover-btn">
                        <a href="/logout" class="text-decoration-none text-white ">LOGOUT</a>
                    </button>
                    </div>
                </li>
                <li id="badgeCount" class="nav-item me-2">
                    <a class="nav-link" href="/users/profile/cart">
                        <i class="fas fa-shopping-cart fa-lg" style="color: #050505;"></i>
                        <span id="badge"><%=userCart.products.length%></span>  <!-- This will show the cart count -->
                    </a>
                </li>
                
    
                <!-- Wishlist/Heart Icon -->
                <li class="nav-item me-2">
                    <a class="nav-link" href="/users/profile/wishlist">
                        <i class="fa-regular fa-heart fa-lg" style="color: #080808;"></i>
                    </a>
                </li>
    
                <!-- User/Contact Icon -->
                <li class="nav-item me-2">
                    <% if (locals.currentUser.photo) { %>
                    <!-- If photo exists, show the photo -->
                    <div class="profile" style="background-image: url('/img/users/<%=locals.currentUser.photo%>');">
                        <a class="nav-link" href="/users/profile"></a>
                    </div>
                    <% } else { %>
                    <!-- If photo doesn't exist, show the icon -->
                    <a class="nav-link" href="/users/profile">
                        <i class="fa-regular fa-user fa-lg" style="color: #0c0c0c;"></i>
                    </a>
                    <% } %>
                </li>
    
            <% }else{%> 
                <!-- login button -->
                <li class="nav-item m-auto">
                        <a href="/login" class="text-decoration-none color-1">LOGIN</a>
                </li>
                <li class="nav-item me-2">
                <a class="nav-link" href="/users/profile/cart">
                    <i class="fas fa-shopping-cart fa-lg" style="color: #050505;"></i>
                    <span id="cartCount" class="badge bg-danger"></span>
                </a>
            </li>
            
    
                <!-- Wishlist/Heart Icon -->
                <li class="nav-item me-2">
                    <a class="nav-link" href="/users/profile/wishlist">
                        <i class="fa-regular fa-heart fa-lg" style="color: #080808;"></i>
                    </a>
                </li>
    
                <%}%>
                    </ul>
            </div>
        </div>
    </nav>
        <!-- nav bar / header == ending -->     


        <!-- product view page userSide -->
        <% if(productDetails !=null){%>
        <div class="container mt-5 ">
            <div class="row justify-content-center "> 
                <div class="row d-flex justify-content-center">
                    <div class="col-lg-6 d-flex justify-content-center align-items-center">
                        <div class="d-flex justify-content-center flex-column mx-3 bg-white mb-2 ">
                            <div class="col-12 col-sm-6 col-md-4 ">
                                <a href="/img/books/<%=productDetails.images[0] %>">
                                    <img class="img-fluid mt-2 scaled thumbimg thumbimgSize" src="/img/books/<%=productDetails.images[0] %>">
                                </a>
                            </div>
                            <div class="col-12 col-sm-6 col-md-4 ">
                                <a href="/img/books/<%=productDetails.images[1] %>">
                                    <img class="img-fluid mt-2 scaled thumbimg thumbimgSize" src="/img/books/<%=productDetails.images[1] %>">
                                </a>
                            </div>                    
                        </div>
                        <div class="mx-3 card mb-2 shadow zoom scaled-main" id="zoomC">
                            <img class="img-fluid mt-2" src="/img/books/<%=productDetails.images[0] %>" alt="" id="mainImg">
                        </div> 
                    </div>
                    <!-- You can put other elements for the remaining half of the screen on larger screens here -->
                </div>
                        <hr>
                        <div class=" col-lg-11 col-md-10  bg-D9D9D9 border rounded-3">
                            <h5 class="text-center text-uppercase pt-1"><%=productDetails.name%></h5>
                            <hr>
                            <div class="d-md-flex">
                                <div class="col-md-6 col-sm-12 ">
                                    <ul class="list-unstyled p-4">
                                        <div class="text-capitalize">
                                            <strong>rating:</strong>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                            <i class="fas fa-star"></i>
                                          </div>
                                          
                                        <li><small><strong>BY:</strong> <a href="/authors?author=<%= productDetails.author._id %>"><%=productDetails.author.name ? productDetails.author.name : 'N/A'%></a></small></li>
                                        <li><small><strong>Book :</strong> <%=productDetails.name%></small></li>
                                        <li><small><strong>Author:</strong> <a href="/authors?author=<%= productDetails.author._id %>"><%=productDetails.author.name ? productDetails.author.name : 'N/A'%></a></small></li>
                                        <li><small><strong>Category :</strong> <%=productDetails.category ? productDetails.category.name : 'N/A'%></small></li>
                                        <li><small><strong>ISBN :</strong> <%=productDetails.bookISBN ? productDetails.bookISBN : 'N/A'%></small></li>
                                        <li><small><strong>Publishing Date :</strong><%= moment(productDetails.Publishingdate).format('ll')  %></small></li>
                                        <li><small><strong>Publisher :</strong> <%=productDetails.publisher%></small></li>
                                        <li><small><strong>Number of pages :</strong> <%=productDetails.numOfPages%></small></li>
                                        <li><small><strong>Language :</strong> <%=productDetails.language%></small></li>
                                    </ul>
                    
                                </div>
                                <div class="col-md-6 col-sm-12 bg-white border rounded-3 my-3 shadow">
                                <div class="mt-3">
                                    <span class="card-text text-success   fs-3 ps-3">₹<%=productDetails.price%></span>
                                    <span class="card-text text-warning  ps-2"><del>₹<%=productDetails.initialPrice%></del></span>
                                    <span class="card-text ps-2"><%=productDetails.discount%>%off</span>
                                    <button class="bg-transparent border-0 float-end pe-3" id="wishlistHeart"
                                    onclick="addToWishlist('<%=productDetails._id%>')"><i
                                      class="fa fs-4 fa-heart <%if(productsInWishlist==null){%>text-black<%}else{%>text-danger<%}%> "></i>
                                    </button>
                                  </div>
                                  <hr>
                                  <div class="ps-3 text-capitalize">
                                    <p><strong>Delivary Status:</strong><small>&nbsp; Free Delivary</small></p>
                                    <!-- <p id="stockCheck"><strong>Stock:</strong><small class="text-success">&nbsp; <%=productDetails.stock%></small></p> -->
                                    <% if(productDetails.stock == '0') { %> 
                                        <p class="text-danger" style="font-weight: bold;margin-top: 10px;">OUT OF STOCK</p>
                                        <p id="singleStockCheck" hidden><%= productDetails.stock %></p>
                                    <% }else{ %>
                                      <p><span class="">Stock</span>:<%= productDetails.stock %></p>
                                      <% } %>
                                    
                                    <!-- <a href="" class="border-3 text-black border border-3 btn"><small>add to wishlist</small> </a> -->
                                    <!-- <button class="bg-transparent border-0" id="wishlistHeart"
                                    onclick="addToWishlist('<%=productDetails._id%>')"><i
                                      class="fa fs-5 fa-heart <%if(productsInWishlist==null){%>text-black<%}else{%>text-danger<%}%> "></i>
                                    </button> -->
                                    <div class=" text-capitalize my-4 gap-4 d-flex">
                                        <!-- <a href="" class="btn color-bg-main text-white">add to cart</a> -->
                                        <div id="addToCart"
                                        class="btn color-bg-main text-white"
                                        onclick="addToCart('<%=productDetails._id%>')">
                                        <span style="font-size: 0.8rem;">Add to cart</span>
                                      </div>
                                        <!-- <a href="/users/directCheckout?stock=<%=productDetails.stock%>&&id=<%=productDetails._id%>"  class="btn color-bg-main text-white">buy now</a> main -->
                                        <!-- <a href="/users/directCheckout?stock=<%=productDetails.stock%>&id=<%=productDetails._id%>"  onclick="singlecheckOut()" type="submit" class="btn color-bg-main text-white" >Buy Now</a> -->
                                        <div id="buyNow"
                                        class="button-div btn color-bg-main text-white"
                                        onclick="buyNow('<%=productDetails._id%>')">
                                        <span style="font-size: 0.8rem;">Buy Now</span>
                                      </div>
                                      </div>
                                  </div>
                                
                                </div>
                                
                            </div>
                            
                        </div>
             
            </div>
            <%}%>
        </div>


         <!--  -->
         <% if(similarProducts && similarProducts.length > 0) { %>
         <div class="container mt-5 ">
            <h3 class="text-capitalize  mb-5 ms-4"><u class="color-G">
                <span class="text-black">similar Products:</span></u></h3>
            <div class="row d-flex " >     
              <!-- edit -->
              <% similarProducts.forEach((product,i)=>{%>
              <div class="d-flex justify-content-center col-lg-3 col-md-3 col-sm-6 mb-5" style="max-width: 15rem;">
                <div class="card prod_card" >
                    <div class="card card_img">
                      <a href="/products/<%=product._id%>">
                        <div class="image-wrapper" style="background-image: url('/img/books/<%=product.thumbnail%>')"></div>
                     </a>               
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                          <span class="card-title text-center fs-6  text-truncate d-inline-block" style="max-width: 170px;"><%=product.name%></span>
                        </div>
                        <div class="d-flex">
                          <div class="m-auto gap-3">
                            <span class="card-text text-success  fs-3">₹<%= product.price%></span>
                            <span class="card-text text-warning "><del>₹<%= product.initialPrice %></del></span>
                            <span class="card-text text-info"><%= product.discount %>% off</span>
                        </div>
                        </div>
                    <p class="card-text text-center">Rating: </p>
                  </div>
                </div>
              </div>
              <%})%>
              <!-- adding next card here -->
            </div>   
            <a href="/allproducts"> Explore..</a>

          </div>
          <% }else{ %>
            <div class="container">
                <h3 class="text-capitalize  my-5 ms-4"><u class="color-G">
                    <span class="text-black">similar Products:</span></u></h3>
                <div class="text-center">
                    <span class="text-center text-capitalize fs-4 text-danger">no similar Products...
                        <a href="/allproducts"> Explore</a>
                    </span>
                </div>
                <hr>
            </div>
            <%}%>
         <!--  -->

        <!-- review page /= && !orderWasCancelled -->
        <% if(hasOrderedProduct){%>
            <div class="container mt-5" id="reviewAdding">
                <div class="row">
                    <!-- Review form -->
                    <div class="col-md-6">
                        <h3>Leave a review</h3>
                        <form action="/users/reviews?productID=<%=productDetails._id%>" method="post" id="reviewForm">
                            <div class="form-group">
                                <label for="productName">Product Name</label>
                                <input type="text" class="form-control" id="productName" name="productName" value="<%=productDetails.name%>" readonly>
                            </div>
                            <div class="form-group">
                                <label for="reviewTitle">Review Title</label>
                                <input type="text" class="form-control" id="reviewTitle" name="reviewTitle">
                            </div>
                            <div class="form-group">
                                <label for="rating">Rating</label>
                                <div id="rating" class="mb-3" data-rating="0">
                                    <i class="far fa-star" data-value="1"></i>
                                    <i class="far fa-star" data-value="2"></i>
                                    <i class="far fa-star" data-value="3"></i>
                                    <i class="far fa-star" data-value="4"></i>
                                    <i class="far fa-star" data-value="5"></i>
                                </div>
                                <input type="hidden" name="rating" id="hiddenRating">
                            </div>
                            <div class="form-group">
                                <label for="message">Your Message</label>
                                <textarea class="form-control" id="review" name="review" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-success my-3 d-flex justify-content-center">Submit</button>
                        </form>
                    </div>
                <% } else { %>
                    <p class="text-center  text-success">Reviews are only allowed for ordered items. Please order the product!!</p>
                <% } %>
                
                <!-- Submitted reviews -->
                <div class="col-md-6 container border border-1 border-black shadow mb-5" style="height: 700px;">
                    <h3 class="p-4">Submitted Reviews:</h3>
                    <% if(reviews && reviews.length > 0) { %>
                        <% reviews.forEach(review => { %>
                        <div class="my-4 bg-white" id="review_<%= review._id %>">
                            <div class="review-item p-2" style="border: 1px solid #ccc;">
                                <div class="d-flex">
                                    <% if(review.customer) { %>
                                        <img src="/img/users/<%= review.customer.photo %>" class="border border-2 border-black rounded-5" alt="<%= review.customer.username%> photo" style="font-family: 'Courier New', Courier, monospace;" width="50" height="50">
                                    <% } else { %>
                                        <!-- Default photo or some placeholder in case there's no customer data -->
                                        <img src="/img/books/animations/no-image.jpg" class="border border-2 border-black rounded-5" alt="Default photo" width="50" height="50">
                                    <% } %>
                                    
                                    <div class="ps-3">
                                        <% if(review.customer) { %>
                                            <span class="text-capitalize reviwSubmit"><%= review.customer.username %></span>
                                        <% } else { %>
                                            <span class="text-capitalize reviwSubmit">Unknown</span>
                                        <% } %>
                                        
                                        <div class="mb-3">
                                            <% for (let i = 1; i <= 5; i++) { %>
                                                <% if (i <= review.rating) { %>
                                                    <i class="fas fa-star selected"></i>
                                                <% } else { %>
                                                    <i class="far fa-star"></i>
                                                <% } %>
                                            <% } %>
                                            <span><%= moment(review.createdAt).format('MMMM Do YYYY, h:mm:ss a') %></span>
                                        </div>
                                    </div>
                                </div>

                                <div class="row ms-5">
                                    <span class="col-12">Product Name:&nbsp;<span class=""><%= review.productName %></span></span>
                                    <span class="col-12 "><%= review.reviewTitle %></span>
                                    <span class="col-12"><%= review.review %></span>
                                </div>
                                <!-- ============ -->
                                <% if(session && session.toString() === review.customer._id.toString()) { %> 
                                    <button onclick="deleteReview('<%= review._id %>')" class="btn btn-danger"><i class="bi bi-file-earmark-x-fill"></i></button>
                                <% } %>
                                
                                
                                
                            </div>
                        </div>
                        <% }); %>
                    <% } else { %>
                        <p>No reviews submitted yet.</p>
                    <% } %>
                </div>
            </div>
            </div>
            
     
            
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="/js/imageZoom.js"></script>

        <script>
              function buyNow(productID) {
    $.ajax({
      url: "/users/profile/cart",
      method: "post",
      data: {
        id: productID,
      },
      success: (res) => {
        if (res.success === "addedToCart" || res.success === "countAdded") {
          window.location.href = "/users/profile/cart";
        }
        else if(res.success === "outofstcok" ){
          Swal.fire({
            toast: true,
            icon: "error",
            position: "top-right",
            showConfirmButton: false,
            timer: 1500,
            timerProgressBar: true,
            animation: true,
            title: "Out Of Stock",
          });
        }
         else {
          window.location.href = "/login";
        }
      },
    });
  }
        </script>

        <script>
            $(document).ready(function() {
            // Star rating
            $('#rating i').click(function() {
                        const ratingValue = $(this).data('value');
                        $('#hiddenRating').val(ratingValue);  // Set hidden input value

                        // Switch stars up to the one clicked to filled stars
                        $('#rating i').slice(0, ratingValue).each(function() {
                            $(this).removeClass('far').addClass('fas selected');
                        });

                        // Switch the others back to bordered stars
                        $('#rating i').slice(ratingValue).each(function() {
                            $(this).removeClass('fas selected').addClass('far');
                        });  
                    });


        });
        $("#reviewForm").submit(function(e) {
            e.preventDefault();
        
            $.ajax({
                type: 'POST',
                url: '/users/reviews?productID=<%=productDetails._id%>',
                data: $(this).serialize(),
                success: (res) => {
                    if(res.success = "reviewAdded"){
                    Swal.fire({
                            toast: true,
                            icon: "success",
                            position: "top-right",
                            showConfirmButton: false,
                            timer: 1000,
                            timerProgressBar: true,
                            animation: true,
                            title: "Review added successfully!",
                  });
                        // alert('Review added successfully!');
                    $("#reviewAdding").load(location.href + " #reviewAdding");
                    $("#reviewPage").load(location.href + " #reviewPage");

                    }else{
                    alert('Error adding review.');
                    }
                },
                error: function(err) {
                    alert('Error adding review.');
                }
            });
        });
        // ===
        $(document).on('click', '.edit-btn', function() {
    let reviewId = $(this).data('review-id');

    // Populate the modal with current review details.
    let reviewTitle = $(this).closest('.review-item').find('.reviwSubmit').text();
    let reviewText = $(this).closest('.review-item').find('span:last-child').text();
    let currentRating = $(this).closest('.review-item').find('.selected').length;

    let modal = $('#editReviewModal_' + reviewId);
    modal.find('input[name="reviewTitle"]').val(reviewTitle);
    modal.find('textarea[name="review"]').val(reviewText);

    adjustStars(modal.find('.rating-div'), currentRating);
});

function adjustStars(ratingDiv, currentRating) {
    ratingDiv.children().each(function(index) {
        if (index < currentRating) {
            $(this).removeClass('far').addClass('fas');
        } else {
            $(this).removeClass('fas').addClass('far');
        }
    });
}
// delete review
function deleteReview(reviewId) {
    // Ask user for confirmation before deleting
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            // If user confirmed, proceed with AJAX request
            $.ajax({
                url: `/users/reviews?id=${reviewId}`,
                method: "DELETE",
                success: function(response) {
                    if (response.success === "removedreview") {
                        Swal.fire({
                            toast: true,
                            icon: "success",
                            position: "top-right",
                            showConfirmButton: false,
                            timer: 1000,
                            timerProgressBar: true,
                            animation: true,
                            title: "Review deleted successfully!",
                        });

                        // Remove the review from the UI
                        $(`#review_${reviewId}`).remove();
                    } else {
                        Swal.fire({
                            toast: true,
                            icon: "error",
                            position: "top-right",
                            showConfirmButton: false,
                            timer: 1000,
                            timerProgressBar: true,
                            animation: true,
                            title: response.message || "Error occurred!",
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        toast: true,
                        icon: "error",
                        position: "top-right",
                        showConfirmButton: false,
                        timer: 1000,
                        timerProgressBar: true,
                        animation: true,
                        title: "Error occurred while deleting review!",
                    });
                }
            });
        }
    });
}

// Assuming every modal has its own review form with a unique ID
// $(document).on('submit', '.modal form', function(e) {
//     e.preventDefault();

//     let reviewId = $(this).closest('.modal').data('review-id');
//     let updatedReview = {
//         reviewTitle: $(this).find('input[name="reviewTitle"]').val(),
//         review: $(this).find('textarea[name="review"]').val(),
//         rating: $(this).find('.selected').length
//     };

//     // AJAX call to submit the edited review
//     $.ajax({
//         type: 'PUT',
//         url: '/users/reviews?reviewId=' + reviewId,
//         data: updatedReview,
//         success: function(response) {
//             if (response.success) {
//                 // Refresh the page or update the review in the DOM as needed.
//                 location.reload();
//             } else {
//                 alert('Error updating review.');
//             }
//         },
//         error: function() {
//             alert('Error updating review.');
//         }
//     });
// });

        </script>
        
        <!-- <i id="wishlistButton" class="far fa-heart"></i> -->
        <%-include('./layout/_footer')%>
 